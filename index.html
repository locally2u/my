<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#A67734">
  <title>Pipah Cookies ‚Äî Premium</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1047/1047711.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <style>
    :root { --primary:#A67734; --primary-dark:#8B5E26; --bg:#FAF9F6; --surface:#FFFFFF; --text-main:#2D241E; --text-muted:#8A817C; --border:#EAE5E0; --radius-lg:24px; --radius-md:16px; --app-max-width:480px; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    body { margin:0; font-family:"Plus Jakarta Sans",sans-serif; background:#eee; color:var(--text-main); user-select:none; min-height:100vh; display:flex; justify-content:center; }
    #mobile-viewport { width:100%; max-width:var(--app-max-width); background:var(--bg); min-height:100vh; position:relative; box-shadow:0 0 40px rgba(0,0,0,0.1); overflow-x:hidden; padding-bottom:120px; }
    h1,h2,h3,h4,button,.brand { font-family:"Outfit",sans-serif; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
    .anim { opacity:0; animation:fadeUp 0.6s forwards; }
    .d-1 { animation-delay:0.1s; } .d-2 { animation-delay:0.2s; } .d-3 { animation-delay:0.3s; } .d-4 { animation-delay:0.4s; }
    
    .zoom-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s ease; }
    .zoom-modal.active { display:flex; opacity:1; }
    .zoom-content { max-width:90%; max-height:80vh; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.5); transform:scale(0.8); transition:transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275); object-fit:contain; }
    .zoom-modal.active .zoom-content { transform:scale(1); }
    .zoom-close { position:absolute; top:20px; right:20px; color:white; font-size:30px; cursor:pointer; background:rgba(255,255,255,0.2); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

    #pipahInstallPopup { position:fixed; top:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:15px 20px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:9990; display:none; opacity:0; transition:opacity 0.4s,top 0.4s; border:1px solid rgba(0,0,0,0.05); text-align:center; }
    #pipahInstallPopup.show { opacity:1; top:80px; }
    .install-btn { background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:20px; margin-top:10px; font-weight:bold; font-size:13px; cursor:pointer; box-shadow:0 4px 10px rgba(166,119,52,0.3); }

    .app-header { position:fixed; top:0; z-index:100; width:100%; max-width:var(--app-max-width); left:50%; transform:translateX(-50%); background:rgba(250,249,246,0.8); backdrop-filter:blur(16px); padding:15px 24px; border-bottom:1px solid rgba(0,0,0,0.03); display:flex; justify-content:space-between; align-items:center; }
    .brand { font-size:22px; font-weight:700; color:var(--primary); letter-spacing:-0.5px; }
    .header-reseller-btn { background:linear-gradient(135deg,#FAD961,#F76B1C); color:white; border:none; padding:8px 16px; border-radius:20px; font-size:11px; font-weight:700; box-shadow:0 4px 10px rgba(247,107,28,0.3); cursor:pointer; transition:0.2s; }
    .header-reseller-btn:active { transform:scale(0.95); }

    .hero-wrapper { margin-top:85px; }
    .slider-container { display:flex; gap:16px; overflow-x:auto; padding:10px 24px 30px 24px; scroll-snap-type:x mandatory; scrollbar-width:none; perspective:1200px; }
    .slider-container::-webkit-scrollbar { display:none; }
    .hero-card { min-width:90%; height:220px; border-radius:var(--radius-lg); scroll-snap-align:center; position:relative; overflow:hidden; background-size:cover; background-position:center; box-shadow:0 20px 40px -10px rgba(0,0,0,0.2); transform-style:preserve-3d; cursor:zoom-in; }
    .hero-overlay { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(to top,rgba(0,0,0,0.8),transparent); padding:24px; display:flex; align-items:flex-end; transform:translateZ(20px); pointer-events:none; }
    .hero-title { color:white; font-size:20px; font-weight:700; margin:0; }

    .section-title { padding:0 24px; margin-top:15px; font-size:20px; font-weight:700; display:flex; align-items:center; gap:10px; color:var(--text-main); }
    .section-title::after { content:''; flex:1; height:1px; background:#eee; }
    .swiper { width:100%; padding-top:20px; padding-bottom:40px; }
    .swiper-slide { background-position:center; background-size:cover; width:220px; height:280px; border-radius:20px; box-shadow:0 15px 30px rgba(0,0,0,0.15); display:flex; align-items:flex-end; overflow:hidden; border:2px solid white; position:relative; cursor:zoom-in; }
    .slide-content { background:rgba(255,255,255,0.95); width:100%; padding:15px; backdrop-filter:blur(8px); transform:translateY(100px); transition:0.4s; display:flex; flex-direction:column; gap:5px; pointer-events:auto; }
    .swiper-slide-active .slide-content { transform:translateY(0); }
    .slide-add-btn { background:var(--primary); color:white; border:none; padding:8px; border-radius:10px; font-size:12px; font-weight:bold; margin-top:5px; width:100%; display:flex; align-items:center; justify-content:center; gap:5px; cursor:pointer; }

    .cat-scroll { display:flex; gap:10px; padding:0 24px; margin:15px 0 15px 0; overflow-x:auto; scrollbar-width:none; }
    .cat-btn { padding:10px 20px; background:var(--surface); border:1px solid var(--border); border-radius:30px; color:var(--text-muted); font-weight:600; font-size:13px; white-space:nowrap; transition:0.3s; }
    .cat-btn.active { background:var(--primary); color:white; border-color:var(--primary); }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:0 24px; }
    .card { background:var(--surface); border-radius:var(--radius-md); padding:12px; box-shadow:var(--shadow-sm); display:flex; flex-direction:column; transition:0.2s; }
    .card:active { transform:scale(0.98); }
    .card-img { width:100%; aspect-ratio:1; object-fit:cover; border-radius:12px; background:#f0f0f0; margin-bottom:12px; cursor:zoom-in; }
    .add-btn { width:32px; height:32px; background:var(--surface); border:1px solid var(--border); border-radius:10px; color:var(--primary); display:flex; align-items:center; justify-content:center; }

    .gallery-item-style { width:120px; height:120px; border-radius:16px; background-size:cover; flex-shrink:0; border:2px solid white; box-shadow:0 10px 15px rgba(0,0,0,0.1); cursor:zoom-in; }

    .nav { position:fixed; bottom:24px; z-index:500; width:calc(100% - 48px); max-width:calc(var(--app-max-width) - 48px); left:50%; transform:translateX(-50%); background:rgba(30,30,30,0.95); backdrop-filter:blur(10px); height:70px; border-radius:40px; display:flex; justify-content:space-around; align-items:center; color:#888; box-shadow:0 15px 35px rgba(0,0,0,0.25); }
    .nav-item.active { color:white; transform:translateY(-3px); }
    .badge { position:absolute; top:5px; right:5px; background:#FF4757; color:white; border:2px solid #222; font-size:9px; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; opacity:0; }
    .badge.show { opacity:1; }
    
    .drawer-overlay { position:fixed; inset:0; z-index:990; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); opacity:0; pointer-events:none; transition:0.3s; display:flex; justify-content:center; }
    .drawer-overlay.open { opacity:1; pointer-events:auto; }
    .drawer { position:fixed; bottom:0; z-index:1000; width:100%; max-width:var(--app-max-width); left:50%; transform:translateX(-50%) translateY(105%); background:var(--surface); border-radius:30px 30px 0 0; transition:0.4s cubic-bezier(0.16,1,0.3,1); display:flex; flex-direction:column; max-height:85vh; box-shadow:0 -10px 40px rgba(0,0,0,0.1); }
    .drawer.open { transform:translateX(-50%) translateY(0); }
    #loader { max-width:var(--app-max-width); left:50%; transform:translateX(-50%); }
  </style>
</head>
<body>

  <div id="mobile-viewport">
      <div id="loader" style="position:fixed; top:0; bottom:0; width:100%; background:var(--bg); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.5s;">
          <div style="font-size:50px; animation:bounce 1s infinite alternate;">üç™</div>
          <p style="margin-top:15px; font-weight:700; color:var(--text-muted); font-size:12px; letter-spacing:1px;">LOADING APP</p>
      </div>

      <div class="zoom-modal" id="zoomModal" onclick="closeZoom()"><div class="zoom-close">‚úï</div><img class="zoom-content" id="zoomImg" src="" alt="Zoom"></div>

      <div id="pipahInstallPopup">
          <div style="font-size:30px; margin-bottom:10px;">üì≤</div>
          <h3 style="margin:0; font-size:16px;">Install Pipah App</h3>
          <p style="margin:5px 0 10px; font-size:12px; color:#666;" id="installText">Akses lebih pantas tanpa buka browser!</p>
          <button class="install-btn" id="btnInstall">Install Sekarang</button>
          <div style="margin-top:10px; font-size:11px; color:#999; cursor:pointer;" onclick="closeInstallPopup()">Nanti Dulu</div>
      </div>

      <header class="app-header">
          <div><div style="font-size:10px; font-weight:600; color:var(--text-muted);">SELAMAT DATANG</div><div class="brand">PipahCookies</div></div>
          <button class="header-reseller-btn" onclick="openReseller()">Buat Duit üí∞</button>
      </header>

      <main id="home-view">
          <div class="hero-wrapper anim d-1"><div class="slider-container" id="hero-slider"></div></div>

          <div class="anim d-2">
              <h2 class="section-title">Trending Now üî•</h2>
              <div class="swiper mySwiper">
                <div class="swiper-wrapper" id="trending-wrapper">
                    <div class="swiper-slide" style="background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">Loading...</div>
                </div>
                <div class="swiper-pagination"></div>
              </div>
          </div>

          <div class="anim d-3">
              <div class="cat-scroll">
                  <button class="cat-btn active" onclick="filterCat('all', this)">Semua</button>
                  <button class="cat-btn" onclick="filterCat('Cookies', this)">Cookies</button>
                  <button class="cat-btn" onclick="filterCat('Brownies', this)">Brownies</button>
                  <button class="cat-btn" onclick="filterCat('Combo', this)">Combo</button>
              </div>
              <div class="grid" id="product-list"></div>
          </div>

          <div class="anim d-4" style="margin-top:30px; padding-bottom:20px;">
              <h3 style="padding:0 24px; margin-bottom:0; font-size:16px; color:#888;">Galeri Kedai üì∏</h3>
              <div class="slider-container" id="gallery-slider" style="padding-top:15px;"></div>
          </div>
      </main>

      <div class="drawer-overlay" id="drawer-overlay" onclick="toggleCart()"></div>
      <div class="drawer" id="cart-drawer">
          <div style="width:40px; height:4px; background:#E0E0E0; border-radius:4px; margin:15px auto;"></div>
          <div style="padding:10px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
              <h2 style="margin:0; font-size:18px;">Bakul Saya</h2>
              <button onclick="toggleCart()" style="background:none; border:none; color:var(--text-muted); font-size:20px;">‚úï</button>
          </div>
          <div style="flex:1; overflow-y:auto; padding:20px 24px;" id="cart-content"></div>
          <div style="padding:24px; background:var(--bg); border-top:1px solid var(--border);">
              <div style="display:flex; justify-content:space-between; font-weight:700; font-size:18px; margin-bottom:20px;">
                  <span>Jumlah</span> <span id="cart-total" style="color:var(--primary);">RM 0.00</span>
              </div>
              <input type="text" id="cust-name" placeholder="Nama Anda" style="width:100%; padding:14px; background:white; border:1px solid var(--border); border-radius:12px; margin-bottom:10px;">
              <textarea id="cust-note" placeholder="Alamat / Nota" rows="2" style="width:100%; padding:14px; background:white; border:1px solid var(--border); border-radius:12px; margin-bottom:15px;"></textarea>
              <button onclick="goToCheckout()" style="width:100%; background:var(--primary); color:white; padding:16px; border:none; border-radius:16px; font-weight:700; font-size:16px; box-shadow:0 8px 20px -5px rgba(166, 119, 52, 0.4);">Semak & Sahkan Order &rarr;</button>
          </div>
      </div>

      <nav class="nav">
          <div class="nav-item active" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i class="fas fa-home"></i></div>
          <div class="nav-item" onclick="toggleCart()"><i class="fas fa-shopping-bag"></i><div class="badge" id="cart-badge">0</div></div>
          <div class="nav-item" onclick="window.open('https://vt.tiktok.com/ZSHTysXR5MaoX-rexjk/','_blank')"><i class="fab fa-tiktok"></i></div>
      </nav>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyA2Y2cOh3J7U916Ip0tnDDFVs2fK6sACl0",
        authDomain: "pipahcookies-21e38.firebaseapp.com",
        projectId: "pipahcookies-21e38",
        storageBucket: "pipahcookies-21e38.firebasestorage.app",
        messagingSenderId: "162482379926",
        appId: "1:162482379926:web:14d16f5a2444816876f6b7"
    };

    let db;
    try { 
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); 
        db = firebase.firestore();
    } catch (e) { 
        console.error("Firebase Failed:", e); 
        // Force hide loader if Firebase fails so app doesn't freeze
        setTimeout(()=>document.getElementById('loader').style.display='none', 500);
    }

    let products = [], cart = JSON.parse(localStorage.getItem('pipah_cart')) || [];
    let settings = { whatsapp: '601121243407', resellerLink: '#' };
    let swiperInstance = null;
    let deferredPrompt; 

    window.onload = function() {
        // Safe timeout to ALWAYS hide loader even if DB errors
        setTimeout(() => { document.getElementById('loader').style.opacity = 0; setTimeout(()=>document.getElementById('loader').style.display='none',500); }, 1500);

        if(!db) return; // Stop if DB init failed

        db.collection('settings').doc('config').onSnapshot(d => { if(d.exists) settings = {...settings, ...d.data()}; });

        db.collection('hero_banners').limit(4).onSnapshot(s => {
            const c = document.getElementById('hero-slider'); c.innerHTML='';
            s.forEach(d => c.innerHTML += `<div class="hero-card" style="background-image: url('${d.data().image}');" data-tilt><div class="hero-overlay"><h2 class="hero-title">${d.data().title||''}</h2></div></div>`);
            VanillaTilt.init(document.querySelectorAll(".hero-card"));
            startAutoSlide();
        });

        // Trending
        db.collection('trending_products').limit(10).onSnapshot(s => {
            const wrapper = document.getElementById('trending-wrapper');
            wrapper.innerHTML = '';
            s.forEach(doc => {
                const d = doc.data(); const pid = doc.id;
                // Add to global products if not exists
                if (!products.find(p => p.id === pid)) { products.push({ id: pid, ...d }); }
                
                wrapper.innerHTML += `
                    <div class="swiper-slide" style="background-image: url('${d.image}')">
                        <div class="slide-content">
                            <h3 style="margin:0; font-size:15px; font-weight:700;">${d.name}</h3>
                            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                <span style="font-size:13px; color:var(--primary); font-weight:bold;">RM ${d.price}</span>
                            </div>
                            <button class="slide-add-btn" onclick="event.stopPropagation(); addToCart('${pid}')"><i class="fas fa-plus-circle"></i> Tambah</button>
                        </div>
                    </div>`;
            });
            if(swiperInstance) swiperInstance.destroy();
            swiperInstance = new Swiper(".mySwiper", { effect: "coverflow", grabCursor: true, centeredSlides: true, slidesPerView: "auto", coverflowEffect: { rotate: 30, stretch: 0, depth: 100, modifier: 1, slideShadows: true }, pagination: { el: ".swiper-pagination" } });
        });

        // Regular Products
        db.collection('products').onSnapshot(s => {
            s.forEach(d => { 
                if(!products.find(p=>p.id===d.id)) products.push({id:d.id, ...d.data()}); 
            });
            renderProducts(products.filter(p=> p.category !== 'Trending'));
        });

        db.collection('gallery_images').limit(20).onSnapshot(s => {
            const c = document.getElementById('gallery-slider'); c.innerHTML='';
            s.forEach(d => c.innerHTML += `<div class="gallery-item-style" style="background-image: url('${d.data().image}');" data-tilt></div>`);
            VanillaTilt.init(document.querySelectorAll("[data-tilt]"));
        });
        updateCartUI();
        checkInstall();
    };

    function openZoom(url) { const m=document.getElementById('zoomModal'); document.getElementById('zoomImg').src=url; m.style.display='flex'; setTimeout(()=>m.classList.add('active'),10); }
    function closeZoom() { const m=document.getElementById('zoomModal'); m.classList.remove('active'); setTimeout(()=>m.style.display='none',300); }
    
    document.addEventListener('click', (e) => {
        if(e.target.classList.contains('card-img')) { openZoom(e.target.src); return; }
        const el = e.target.closest('.hero-card, .swiper-slide, .gallery-item-style');
        if(el) {
            if(e.target.closest('.slide-add-btn') || e.target.closest('.add-btn')) return;
            const bg = window.getComputedStyle(el).backgroundImage;
            if(bg && bg!=='none') openZoom(bg.slice(4,-1).replace(/"/g,""));
        }
    });

    function checkInstall() {
        if(!localStorage.getItem('pipahInstalled')) {
            setTimeout(() => {
                const popup = document.getElementById('pipahInstallPopup');
                if(deferredPrompt) {
                    popup.style.display = 'block'; setTimeout(()=>popup.classList.add('show'), 50);
                }
            }, 3000);
        }
    }
    
    function closeInstallPopup() {
        const popup = document.getElementById('pipahInstallPopup');
        popup.classList.remove('show'); setTimeout(() => popup.style.display='none', 400);
    }

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

    document.getElementById('btnInstall').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') { localStorage.setItem('pipahInstalled', 'true'); }
            deferredPrompt = null; closeInstallPopup();
        }
    });

    function startAutoSlide() { const s=document.getElementById('hero-slider'); setInterval(()=>{ if(s) { s.scrollLeft+=s.offsetWidth; if(s.scrollLeft>=s.scrollWidth-s.offsetWidth) s.scrollLeft=0; } }, 5000); }
    function renderProducts(l) { const g=document.getElementById('product-list'); g.innerHTML=''; l.forEach(p=>{ g.innerHTML+=`<div class="card"><img src="${p.image}" class="card-img"><div style="font-size:10px; color:#8A817C; font-weight:600;">${p.category}</div><div style="font-weight:700; font-size:14px; margin-bottom:4px;">${p.name}</div><div style="margin-top:auto; display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:700; color:#A67734;">RM ${p.price}</div><button class="add-btn" onclick="addToCart('${p.id}')"><i class="fas fa-plus"></i></button></div></div>`; }); }
    function filterCat(c,b) { document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); const l=products.filter(p=>p.category!=='Trending'); renderProducts(c==='all'?l:l.filter(p=>p.category===c)); }
    function addToCart(id) { const p=products.find(x=>x.id===id), i=cart.find(x=>x.id===id); if(!p)return; i?i.qty++:cart.push({...p,qty:1}); saveCart(); const b=document.getElementById('cart-badge'); b.style.transform="scale(1.4)"; setTimeout(()=>b.style.transform="scale(1)",200); }
    function saveCart() { localStorage.setItem('pipah_cart', JSON.stringify(cart)); updateCartUI(); }
    function updateCartUI() { const l=document.getElementById('cart-content'); l.innerHTML=''; let t=0,c=0; cart.forEach((x,i)=>{ t+=x.price*x.qty; c+=x.qty; l.innerHTML+=`<div style="display:flex; gap:12px; margin-bottom:16px; align-items:center;"><img src="${x.image}" style="width:50px; height:50px; border-radius:10px; object-fit:cover;"><div style="flex:1;"><div style="font-weight:700; font-size:13px;">${x.name}</div><div style="font-size:12px; color:#888;">RM ${x.price}</div></div><div style="background:#f5f5f5; padding:4px 8px; border-radius:8px; display:flex; gap:8px;"><button onclick="modQty(${i},-1)" style="border:none;">-</button><span style="font-weight:700; font-size:13px;">${x.qty}</span><button onclick="modQty(${i},1)" style="border:none; color:#A67734;">+</button></div></div>`; }); document.getElementById('cart-total').innerText="RM "+t.toFixed(2); document.getElementById('cart-badge').innerText=c; document.getElementById('cart-badge').classList.toggle('show',c>0); if(c===0)l.innerHTML='<div style="text-align:center; padding-top:40px; color:#ccc;">Bakul kosong</div>'; }
    function modQty(i,d) { cart[i].qty+=d; if(cart[i].qty<=0)cart.splice(i,1); saveCart(); }
    function toggleCart() { document.getElementById('cart-drawer').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
    function goToCheckout() { if(cart.length===0) return alert("Bakul kosong!"); const n=document.getElementById('cust-name').value, o=document.getElementById('cust-note').value; if(!n) return alert("Sila masukkan nama."); localStorage.setItem('pipah_order_info', JSON.stringify({ orderId:'ORD-'+Math.floor(100000+Math.random()*900000), date:new Date().toISOString(), buyerName:n, buyerAddress:o||'-', whatsappAdmin:settings.whatsapp })); window.location.href='invois.html'; }
    function openReseller() { if(settings.resellerLink) window.open(settings.resellerLink, '_blank'); }

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Fail', err)); }); }
  </script>
</body>
</html>


