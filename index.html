<!doctype html>
<html lang="ms">
<head>
  <link rel="apple-touch-icon" href="images/rs194.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PipahCookies ‚Äî Reseller Portal v2</title>
  <style>
   :root{ --primary:#A67734; --primary-dark:#8c632a; --accent:#fff1e6; --bg:#fff8f2; --card:#ffffff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Fredoka",sans-serif;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
  h1,h2,h3{font-family:"Poppins",sans-serif;color:var(--primary-dark);margin:0 0 8px}
  .site-header{display:block}
  .header-img{width:100%;height:auto;display:block;object-fit:cover;max-height:360px;border-radius:0 0 14px 14px;box-shadow:0 8px 18px rgba(0,0,0,0.06)}
  .site-nav{position:sticky;top:0;background:var(--primary);z-index:40;padding:10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
  .nav-list{list-style:none;margin:0;padding:0;display:flex;gap:12px;justify-content:center;}
  .nav-list a{color:#fff;text-decoration:none;font-weight:700;padding:8px 12px;border-radius:8px;}
  .section{padding:36px 18px}
  .products { display:flex;flex-wrap:wrap;gap:20px;justify-content:center }
  .product-card { flex:0 0 calc(50% - 10px); max-width: 400px; background:var(--card); padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); display:flex; flex-direction:column; justify-content:space-between; transition: transform 0.2s; }
  .product-card:hover { transform: translateY(-5px); }
  .product-img{ width: 100%; height:200px; object-fit:cover; border-radius:10px; cursor: zoom-in; background: #eee; }
  .qty-control{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0}
  .qty-btn{background:var(--primary);color:#fff;border:none;padding:5px 12px;border-radius:6px;font-size:18px;cursor:pointer;}
  .qty-input{width:50px;text-align:center;border-radius:6px;border:1px solid #ddd;padding:6px;font-weight:bold;}
  .btn{display:block;width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;background:var(--primary);color:#fff;margin-top:10px;}
  .btn:active { transform: scale(0.98); }
  
  /* Cart & Modal */
  #cart-icon{position:fixed;right:20px;bottom:30px;width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;z-index:100;box-shadow:0 10px 25px rgba(166, 119, 52, 0.4);}
  #cart-badge{position:absolute;top:0;right:0;background:#ff3b3b;color:#fff;width:24px;height:24px;border-radius:50%;font-size:12px;font-weight:bold;display:flex;align-items:center;justify-content:center;border:2px solid #fff;}
  .cart-panel{position:fixed;right:20px;bottom:100px;width:350px;max-width:90%;max-height:80vh;overflow-y:auto;background:#fff;padding:20px;border-radius:16px;box-shadow:0 30px 60px rgba(0,0,0,0.2);z-index:99;transform:translateY(20px);opacity:0;pointer-events:none;transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);}
  .cart-panel.show{transform:translateY(0);opacity:1;pointer-events:auto;}
  .zoom-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; }
  .zoom-modal.active { display: flex; }
  .zoom-img { max-width: 95%; max-height: 95%; border-radius: 8px; }
  .price-tag { font-size: 1.1em; font-weight: bold; color: var(--primary); }
  .price-tag.discount { color: #25d366; }
  </style>
</head>
<body>

  <header class="site-header"><img src="images/rshd.png" alt="Pipah Cookies" class="header-img"></header>
  <nav class="site-nav"><ul class="nav-list"><li><a href="#products">Produk</a></li><li><a href="#contact">Hubungi HQ</a></li></ul></nav>

  <main>
    <section class="section" style="padding: 18px; text-align: center; background: var(--accent);">
        <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Alat Reseller</h3>
        <a href="RSDashboard.html" class="btn" style="display:inline-block; width:auto; padding: 10px 25px;">üñ•Ô∏è Dashboard</a>
    </section>

    <section id="products" class="section">
      <h2 style="text-align:center;color:var(--primary-dark)">Senarai Produk</h2>
      <div class="products" id="product-grid">
         <div style="padding:40px;color:#999;">Sedang memuatkan produk...</div>
      </div>
    </section>
  </main>

  <div id="zoom-modal" class="zoom-modal" onclick="this.classList.remove('active')">
    <img id="zoom-image" class="zoom-img" src="">
  </div>

  <button id="cart-icon" onclick="toggleCart()">
      üõí <span id="cart-badge">0</span>
  </button>

  <aside id="cart-panel" class="cart-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px;">
        <h3 style="margin:0">Troli Reseller</h3>
        <button onclick="toggleCart()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
    </div>
    
    <ul id="cart-items" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px"></ul>
    
    <div style="margin-top:20px;border-top:2px dashed #eee;padding-top:15px;">
        <div style="display:flex;justify-content:space-between;font-weight:bold;font-size:1.2em;margin-bottom:15px;">
            <span>Jumlah Besar:</span>
            <span id="cart-total">RM 0.00</span>
        </div>
        
        <div id="checkout-form" class="hidden">
            <input id="full-name" type="text" placeholder="Nama Penuh / Brand Reseller" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;margin-bottom:10px;">
            <button class="btn" style="background:#25d366;" onclick="sendOrder()">üì§ Hantar Order (WhatsApp)</button>
        </div>
        <button id="btn-checkout" class="btn" onclick="document.getElementById('checkout-form').classList.remove('hidden'); this.style.display='none'">Checkout</button>
    </div>
  </aside>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyABXTYtbuFrlYo3AubzNQKOE2hRWSkompU",
      authDomain: "pipahcookies-d6b3b.firebaseapp.com",
      projectId: "pipahcookies-d6b3b",
      storageBucket: "pipahcookies-d6b3b.firebasestorage.app",
      messagingSenderId: "257181224275",
      appId: "1:257181224275:web:d1f9f2e9b57e07186fe5a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let products = [];
    const CART_KEY = 'pipah_reseller_cart_v2';
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    const WHATSAPP_NUMBER = "601123456789"; // GANTI DENGAN NOMBOR HQ

    // --- LOGIC UTAMA ---

    onSnapshot(query(collection(db, 'products'), orderBy('name')), (snap) => {
        products = [];
        snap.forEach(doc => products.push({id: doc.id, ...doc.data()}));
        renderProducts();
        updateCartUI(); // Update UI kalau-kalau produk dalam cart dah berubah harga
    });

    // Kira harga berdasarkan Tiers
    window.getResellerCost = (id, totalQty) => {
        const p = products.find(x => x.id === id);
        if(!p) return { cost: 0, label: 'Error' };
        
        // Pastikan tiers wujud dan valid, kalau tak guna RRP
        if (!p.tiers || p.tiers.length === 0) return { cost: p.rrp, label: 'Retail' };
        
        // Sort tiers dari besar ke kecil (50, 10, 1)
        const tiers = [...p.tiers].sort((a,b) => b.min - a.min);
        
        // Cari tier yang layak
        const match = tiers.find(t => totalQty >= t.min);
        
        return match ? { cost: match.price, label: `Harga Borong (Min ${match.min})` } : { cost: p.rrp, label: 'Harga Retail' };
    };

    function renderProducts(){
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        if(products.length === 0) { grid.innerHTML = '<p>Tiada produk dijumpai.</p>'; return; }

        products.forEach(p => {
            const img = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/400x400/e2e8f0/999?text=No+Image';
            
            // Kira harga asas (Tier paling rendah atau RRP)
            const basePrice = p.tiers && p.tiers.length > 0 ? p.tiers[0].price : p.rrp;

            const card = document.createElement('article');
            card.className = 'product-card';
            card.innerHTML = `
                <div>
                    <img src="${img}" class="product-img" onclick="openZoom('${img}')">
                    <h3 style="margin-top:10px;font-size:1.1em;line-height:1.3">${p.name}</h3>
                </div>
                <div>
                    <div style="margin:10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.9em;color:#666">Anggaran Kos:</span>
                        <strong id="display-price-${p.id}" class="price-tag">RM ${basePrice.toFixed(2)}</strong>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="adjQty('${p.id}', -1)">‚àí</button>
                        <input id="qty-${p.id}" class="qty-input" type="number" value="1" min="1" onchange="validateInput('${p.id}')" oninput="updDisplayPrice('${p.id}')">
                        <button class="qty-btn" onclick="adjQty('${p.id}', 1)">+</button>
                    </div>
                    <button class="btn" onclick="addToCart('${p.id}')">Tambah ke Troli</button>
                </div>
            `;
            grid.appendChild(card);
            // Trigger price update sekali untuk initial state
            setTimeout(() => updDisplayPrice(p.id), 0);
        });
    }

    // --- UI ACTIONS ---

    window.openZoom = (src) => { document.getElementById('zoom-image').src = src; document.getElementById('zoom-modal').classList.add('active'); };

    window.adjQty = (id, d) => {
        const el = document.getElementById(`qty-${id}`);
        let v = parseInt(el.value) + d;
        if(v < 1) v = 1;
        el.value = v;
        updDisplayPrice(id);
    };

    window.validateInput = (id) => {
        const el = document.getElementById(`qty-${id}`);
        if(el.value < 1 || isNaN(el.value)) el.value = 1;
        updDisplayPrice(id);
    };

    window.updDisplayPrice = (id) => {
        const qty = parseInt(document.getElementById(`qty-${id}`).value || 1);
        const { cost, label } = window.getResellerCost(id, qty);
        const el = document.getElementById(`display-price-${id}`);
        const p = products.find(x => x.id === id);
        
        el.innerText = `RM ${cost.toFixed(2)}`;
        // Tukar warna hijau jika harga lebih murah dari RRP
        if(p && cost < p.rrp) el.classList.add('discount');
        else el.classList.remove('discount');
    };

    // --- CART LOGIC (SMART MERGE) ---

    window.addToCart = (id) => {
        const qtyToAdd = parseInt(document.getElementById(`qty-${id}`).value);
        const p = products.find(x => x.id === id);
        
        // Cari jika item dah ada dalam cart
        const existingItem = cart.find(x => x.id === id);

        if(existingItem) {
            // Kalau dah ada, tambah quantity
            existingItem.qty += qtyToAdd;
            // KIRA SEMULA harga unit berdasarkan TOTAL quantity baru (Auto Wholesale Pricing)
            const { cost } = window.getResellerCost(id, existingItem.qty);
            existingItem.unitPrice = cost; 
        } else {
            // Kalau belum ada, masuk baru
            const { cost } = window.getResellerCost(id, qtyToAdd);
            cart.push({
                id: id,
                name: p.name,
                unitPrice: cost,
                qty: qtyToAdd
            });
        }
        
        saveCart();
        updateCartUI();
        toggleCart(); // Buka cart tunjuk user
        
        // Reset input quantity kepada 1
        document.getElementById(`qty-${id}`).value = 1;
        updDisplayPrice(id);
    };

    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        saveCart();
        updateCartUI();
    };

    window.toggleCart = () => document.getElementById('cart-panel').classList.toggle('show');

    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    
    function updateCartUI(){
        const list = document.getElementById('cart-items');
        list.innerHTML = '';
        let total = 0, count = 0;
        
        cart.forEach((item, idx) => {
            // Recalculate price in case admin changed price in DB live
            const { cost } = window.getResellerCost(item.id, item.qty);
            item.unitPrice = cost; 
            
            const lineTotal = item.qty * item.unitPrice;
            total += lineTotal;
            count += item.qty;

            list.innerHTML += `
                <li style="background:#f9fafb;padding:10px;border-radius:8px;border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="font-size:12px;color:#666;margin-top:2px;">
                            ${item.qty} unit x RM ${item.unitPrice.toFixed(2)}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--primary);">RM ${lineTotal.toFixed(2)}</div>
                        <button onclick="removeFromCart(${idx})" style="color:red;border:none;background:none;font-size:12px;cursor:pointer;text-decoration:underline;">Buang</button>
                    </div>
                </li>`;
        });
        
        document.getElementById('cart-total').innerText = `RM ${total.toFixed(2)}`;
        document.getElementById('cart-badge').innerText = count;
        // Simpan semula harga terkini
        saveCart();
    }

    window.sendOrder = () => {
        const name = document.getElementById('full-name').value;
        if(!name) { alert("Sila isi Nama/Brand anda."); return; }
        
        let msg = `*ORDER BARU (RESELLER)*\n`;
        msg += `üë§ Nama: ${name}\n`;
        msg += `üìÖ Tarikh: ${new Date().toLocaleDateString()}\n\n`;
        msg += `*SENARAI ITEM:*\n`;
        
        let total = 0;
        cart.forEach(i => {
            msg += `‚ñ´Ô∏è ${i.qty}x ${i.name} (@ RM${i.unitPrice.toFixed(2)})\n`;
            total += i.qty * i.unitPrice;
        });
        
        msg += `\n*JUMLAH BESAR: RM ${total.toFixed(2)}*`;
        msg += `\n\n_Mohon sahkan stok & pembayaran._`;
        
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
        
        // Optional: Clear cart after order? 
        // cart = []; saveCart(); updateCartUI();
    };

  </script>
</body>
</html>
