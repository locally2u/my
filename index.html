<!doctype html>
<html lang="ms">
<head>
  <link rel="apple-touch-icon" href="images/rs194.png">
  <link rel="manifest" href="reseller-manifest.json">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PipahCookies ‚Äî Reseller Portal</title>
  <style>
   :root{ --primary:#A67734; --primary-dark:#d4b390; --accent:#fff1e6; --whatsapp:#25d366; --bg:#fff8f2; --card:#ffffff; --muted:#6b6b6b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Fredoka",sans-serif;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
  h1,h2,h3{font-family:"Poppins",sans-serif;color:var(--primary-dark);margin:0 0 8px}
  a{color:inherit}
  .site-header{display:block}
  .header-img{width:100%;height:auto;display:block;object-fit:cover;max-height:360px;border-radius:0 0 14px 14px;box-shadow:0 8px 18px rgba(0,0,0,0.06);animation:fadeUp .9s both}
  .site-nav{position:sticky;top:0;background:var(--primary);z-index:40;padding:10px 0}
  .nav-list{list-style:none;margin:0;padding:0;display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap}
  .nav-list a{color:#fff;text-decoration:none;font-weight:700;padding:8px 12px;border-radius:8px;transition:transform .15s}
  .section{padding:36px 18px}
  .products { display:flex;flex-wrap:wrap;gap:20px;justify-content:center }
  .product-card { flex:0 0 calc(50% - 10px); max-width: 400px; height:420px; background:var(--card); padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); overflow:hidden; text-align:center; display:flex; flex-direction:column; justify-content:space-between }
  .product-slider{position:relative;overflow:hidden;border-radius:10px;}
  .slider-wrapper { display: flex; transition: transform 0.3s ease-out; }
  .product-img{ width: 100%; flex-shrink: 0; height:240px; object-fit:cover; display:block; border-radius:10px; cursor: zoom-in; }
  .slider-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
  .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.6);cursor:pointer}
  .dot.active{background:var(--primary-dark)}
  .qty-control{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0}
  .qty-btn{background:var(--primary);color:#fff;border:none;padding:6px 12px;border-radius:8px;font-size:18px;cursor:pointer;transition:transform .12s}
  .qty-input{min-width:48px;text-align:center;border-radius:8px;border:1px solid #eee;padding:6px;background:#fff}
  .btn{display:inline-block;padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;transition:transform .14s,box-shadow .14s}
  .btn.primary{background:var(--primary);color:#fff}
  #cart-icon{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:9998;box-shadow:0 14px 30px rgba(0,0,0,0.16)}
  #cart-badge{position:absolute;top:6px;right:6px;background:#ff3b3b;color:#fff;padding:3px 7px;border-radius:50%;font-weight:800;font-size:12px}
  .cart-panel{position:fixed;right:20px;bottom:92px;width:340px;max-height:72vh;overflow:auto;background:#fff;padding:12px;border-radius:12px;box-shadow:0 30px 60px rgba(0,0,0,0.18);z-index:9997;transform:translateY(10px);opacity:0;pointer-events:none}
  .cart-panel.show{transform:translateY(0);opacity:1;pointer-events:auto;animation:slideUp .26s both}
  .hidden{display:none}
  .zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 9000; }
  .zoom-modal.active { display: flex; }
  .zoom-modal-content { max-width: 90%; max-height: 90%; border-radius: 12px; }
  @keyframes slideUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

  <header class="site-header"><img src="images/rshd.png" alt="Pipah Cookies" class="header-img"></header>
  <nav class="site-nav"><ul class="nav-list"><li><a href="#products">Produk</a></li><li><a href="#contact">Hubungi</a></li></ul></nav>

  <main>
    <section class="section" style="padding: 18px; text-align: center; background: var(--accent);">
        <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Alat Reseller Lain</h3>
        <a href="RSDashboard.html" class="btn primary" style="padding: 12px 25px;">üñ•Ô∏è RS Dashboard</a>
    </section>

    <section id="products" class="section">
      <h2 style="text-align:center;color:var(--primary-dark);margin-bottom:16px">Produk</h2>
      <div class="products" id="product-grid">
         <div style="width:100%;text-align:center;padding:40px;color:#888;">Loading Products from Cloud...</div>
      </div>
    </section>
  </main>

  <div id="zoom-modal" class="zoom-modal" onclick="this.classList.remove('active')"><img id="zoom-image" class="zoom-modal-content" src=""></div>

  <button id="cart-icon" onclick="toggleCart()"><span class="icon">üõí</span><span id="cart-badge">0</span></button>

  <aside id="cart-panel" class="cart-panel">
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>Troli Anda</h3><button onclick="toggleCart()" style="background:none;border:none;font-size:18px">‚úï</button></div>
    <ul id="cart-items" style="list-style:none;padding:0;margin:10px 0;display:flex;flex-direction:column;gap:8px"></ul>
    <p id="cart-total" style="font-weight:bold;text-align:right">Jumlah: RM 0.00</p>
    <div id="checkout-form" class="hidden" style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <input id="full-name" type="text" placeholder="Nama penuh" style="padding:8px;border:1px solid #ccc;border-radius:4px">
        <button class="btn primary" onclick="sendOrder()">Hantar Order WhatsApp</button>
    </div>
    <button class="btn primary" style="width:100%;margin-top:10px" onclick="document.getElementById('checkout-form').classList.remove('hidden')">Checkout</button>
  </aside>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ö†Ô∏è PASTE YOUR FIREBASE CONFIG HERE ‚ö†Ô∏è
    const firebaseConfig = {
        apiKey: "", 
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: ""
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let products = [];
    const CART_KEY = 'pipah_reseller_cart_v2';
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    const WHATSAPP_NUMBER = "601123456789"; // HQ Number

    // 1. FETCH PRODUCTS
    onSnapshot(query(collection(db, 'products'), orderBy('name')), (snap) => {
        products = [];
        snap.forEach(doc => products.push({id: doc.id, ...doc.data()}));
        renderProducts();
        updateCartUI();
    });

    // 2. RESELLER COST LOGIC (Based on Database Tiers)
    window.getResellerCost = (id, qty) => {
        const p = products.find(x => x.id === id);
        if(!p || !p.tiers) return { cost: 0, name: 'Error' };
        
        // Find applicable tier
        // Tiers are saved as [{price: X, min: 1}, {price: Y, min: 10}, {price: Z, min: 50}]
        // We sort by min qty desc to find the highest matching tier
        const tiers = [...p.tiers].sort((a,b) => b.min - a.min);
        const match = tiers.find(t => qty >= t.min);
        
        return match ? { cost: match.price, name: `Min ${match.min}` } : { cost: p.rrp, name: 'Retail' };
    };

    function renderProducts(){
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        products.forEach(p => {
            const img = p.images?.[0] || 'https://placehold.co/400';
            const cost1 = p.tiers?.[0]?.price || p.rrp; // Base cost

            const card = document.createElement('article');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="product-slider" onclick="openZoom('${img}')">
                    <img src="${img}" class="product-img">
                </div>
                <h3>${p.name}</h3>
                <div class="qty-control">
                    <button class="qty-btn" onclick="adjQty('${p.id}', -1)">‚àí</button>
                    <input id="qty-${p.id}" class="qty-input" type="number" value="1" min="1" oninput="updPrice('${p.id}')">
                    <button class="qty-btn" onclick="adjQty('${p.id}', 1)">+</button>
                </div>
                <div style="margin-bottom:8px">Cost/Unit: <strong id="unit-${p.id}">RM ${cost1.toFixed(2)}</strong></div>
                <button class="btn primary" onclick="addToCart('${p.id}')">Tambah ke Troli</button>
            `;
            grid.appendChild(card);
        });
    }

    // Expose functions to global scope for HTML onclick
    window.adjQty = (id, d) => {
        const el = document.getElementById(`qty-${id}`);
        let v = parseInt(el.value) + d;
        if(v < 1) v = 1;
        el.value = v;
        window.updPrice(id);
    };

    window.updPrice = (id) => {
        const el = document.getElementById(`qty-${id}`);
        const display = document.getElementById(`unit-${id}`);
        const qty = parseInt(el.value || 1);
        const { cost } = window.getResellerCost(id, qty);
        display.innerText = `RM ${cost.toFixed(2)}`;
        display.style.color = (cost < (products.find(x=>x.id===id).rrp)) ? '#25d366' : '#A67734'; // Green if discounted
    };

    window.openZoom = (src) => { document.getElementById('zoom-image').src = src; document.getElementById('zoom-modal').classList.add('active'); };

    // CART LOGIC
    window.addToCart = (id) => {
        const qty = parseInt(document.getElementById(`qty-${id}`).value);
        const p = products.find(x => x.id === id);
        const { cost } = window.getResellerCost(id, qty); // Lock in the price at moment of adding
        
        const existing = cart.find(x => x.id === id && x.unitPrice === cost);
        if(existing) existing.qty += qty;
        else cart.push({ id, name: p.name, unitPrice: cost, qty });
        
        saveCart(); updateCartUI();
        alert("Item added!");
    };

    window.removeFromCart = (idx) => { cart.splice(idx, 1); saveCart(); updateCartUI(); };
    window.toggleCart = () => document.getElementById('cart-panel').classList.toggle('show');

    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    
    function updateCartUI(){
        const list = document.getElementById('cart-items');
        list.innerHTML = '';
        let total = 0, count = 0;
        
        cart.forEach((item, idx) => {
            total += item.qty * item.unitPrice;
            count += item.qty;
            list.innerHTML += `
                <li style="background:#fff9f5;padding:8px;border-radius:8px;border:1px solid #eee">
                    <div style="display:flex;justify-content:space-between">
                        <strong>${item.name}</strong>
                        <button onclick="removeFromCart(${idx})" style="color:red;border:none;background:none">x</button>
                    </div>
                    <div style="font-size:12px;color:#666">${item.qty} x RM ${item.unitPrice.toFixed(2)} = RM ${(item.qty*item.unitPrice).toFixed(2)}</div>
                </li>`;
        });
        document.getElementById('cart-total').innerText = `Jumlah: RM ${total.toFixed(2)}`;
        document.getElementById('cart-badge').innerText = count;
    }

    window.sendOrder = () => {
        const name = document.getElementById('full-name').value;
        if(!name) return alert("Sila isi nama");
        
        let msg = `Order Baru (Reseller)\nNama: ${name}\n\n`;
        let total = 0;
        cart.forEach(i => {
            msg += `${i.qty}x ${i.name} @ RM${i.unitPrice} = RM${(i.qty*i.unitPrice).toFixed(2)}\n`;
            total += i.qty*i.unitPrice;
        });
        msg += `\nTotal: RM ${total.toFixed(2)}`;
        
        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
    };

  </script>
</body>
</html>
